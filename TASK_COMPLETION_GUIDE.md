# Руководство: Система задач и уведомлений

## Что реализовано

### 1. Завершение задач менеджером
- Менеджеры видят задачи от ОМ в личном кабинете
- Кнопка "Выполнено" для отметки завершения задачи
- Автоматическое уведомление ОМ о выполнении

### 2. Автоматические уведомления ОМ

#### При выполнении задачи вовремя ✅
- **Цвет:** Зеленый фон
- **Сообщение:** "Задача выполнена"
- **Содержание:** Название задачи, ФИО менеджера, описание, срок, время выполнения

#### При выполнении задачи с опозданием ❌
- **Цвет:** Красный фон и текст
- **Метка:** ПРОСРОЧЕНО
- **Сообщение:** "Задача выполнена с опозданием"
- **Содержание:** Название задачи, ФИО менеджера, описание, срок, время выполнения

#### При просрочке задачи ⏰ (через CRON)
- **Цвет:** Красный фон
- **Сообщение:** "НАПОМИНАНИЕ: Задача просрочена!"
- **Содержание:** Задача до сих пор не выполнена + детали

### 3. База данных

Созданы таблицы:
- `employee_messages` - сообщения между сотрудниками
- Добавлены поля в `manager_tasks`:
  - `completed_at` - время выполнения
  - `completed_by` - кто выполнил
  - `is_overdue` - флаг просрочки

### 4. Backend функции

#### `employee-messages`
- **URL:** `https://functions.poehali.dev/43b26aef-407e-4fcb-9a6c-df92bda05452`
- **Назначение:** Управление сообщениями между сотрудниками

#### `manager-task-complete`
- **URL:** `https://functions.poehali.dev/d306fd9e-8d52-42ef-9d0b-e98812d164ea`
- **Назначение:** Завершение задачи с автоматическим уведомлением ОМ

#### `cron-check-overdue-tasks`
- **URL:** `https://functions.poehali.dev/60a671c5-8243-4b6b-a4f6-e28421ebfd07`
- **Назначение:** Автоматическая проверка просроченных задач (настроить через CRON)

### 5. Frontend компоненты

#### `ManagerTasksList`
- Отображает список задач от ОМ
- Показывает просроченные задачи красным цветом
- Кнопка "Выполнено" для завершения
- Отображение срока выполнения

#### `MessagesDialog` (обновлен)
- Цветовое выделение сообщений:
  - Красный фон - просроченные задачи
  - Зеленый фон - выполненные задачи
  - Синий фон - обычные сообщения
- Поддержка прикрепления файлов (фото, документы)

## Как использовать

### Для менеджера:
1. Зайдите в личный кабинет
2. Увидите блок "Задачи от ОМ"
3. Просроченные задачи выделены красным
4. Нажмите "Выполнено" для завершения задачи
5. ОМ автоматически получит уведомление

### Для ОМ:
1. Откройте "Сообщения" в личном кабинете
2. Все уведомления о задачах будут видны:
   - ✅ Зеленые - выполнено вовремя
   - ❌ Красные - выполнено с опозданием
   - ⏰ Красные - напоминание о просрочке

### Настройка CRON (для админа):
1. Настройте автоматический вызов:
   ```bash
   curl "https://functions.poehali.dev/60a671c5-8243-4b6b-a4f6-e28421ebfd07"
   ```
2. Рекомендуемое расписание: каждые 6 часов
3. Можно использовать:
   - Yandex Cloud Functions триггеры
   - cron-job.org
   - GitHub Actions

## Примеры уведомлений

### Выполнено вовремя:
```
✅ Задача "Связаться с владельцами" выполнена

Менеджер: Иванов Иван
Описание: Прозвонить всех владельцев
Срок: 05.02.2026 18:00
Выполнено: 05.02.2026 15:30
```

### Выполнено с опозданием:
```
❌ ПРОСРОЧЕНО: Задача "Продлить подписки" выполнена с опозданием

Менеджер: Петров Петр
Описание: Продлить подписку на объекты
Срок: 04.02.2026 12:00
Выполнено: 05.02.2026 10:00
```

### Напоминание о просрочке:
```
⏰ НАПОМИНАНИЕ: Задача просрочена!

Задача: "Отчет по работе"
Менеджер: Сидоров Сидор
Описание: Подготовить отчет за неделю
Срок был: 03.02.2026 17:00
Просрочена с: 05.02.2026 09:00

❗ Задача до сих пор не выполнена
```

## Технические детали

- Все уведомления сохраняются в базе данных
- История сообщений доступна всегда
- Файлы загружаются на CDN
- Максимальный размер файла: 10МБ
- Поддерживаемые форматы: изображения, PDF, документы
