# Система позиций и аукциона

## Как работает система позиций

### 1. Позиции отелей по городам

Каждый город имеет свою независимую систему позиций, начиная с #1:

**Текущее состояние:**
- **Екатеринбург**: 3 отеля (позиции 1-3)
- **Москва**: 15 отелей (позиции 1-15)

**Поле в базе данных:**
- Таблица `listings`, поле `auction` — текущая позиция отеля в своём городе

### 2. Отображение позиций

**Админ-панель (`/admin`):**
- Показывает позицию каждого отеля в карточке
- Бейдж "Позиция: #N"
- Группировка по городам с правильной сортировкой

**Личный кабинет владельца (`/owner/dashboard`):**
- **Вкладка "Мои объекты"**: Показывает позицию в бейдже "Позиция #N"
- **Вкладка "Аукцион"**: 
  - Большая карточка: "Ваша позиция #N"
  - Список всех позиций с возможностью перебивания
  - Текущая позиция отмечена фиолетовым цветом

**Публичный сайт (`/`):**
- Отели сортируются по городу (алфавит), затем по позиции `auction`
- При выборе города в фильтре показываются объекты в порядке их позиций

### 3. Изменение позиций через аукцион

**Механизм:**
1. Владелец выбирает желаемую позицию
2. Платит базовую цену или перебивает текущую ставку (+5₽)
3. При перебивании:
   - Текущий владелец позиции сдвигается на +1
   - Все ниже него также сдвигаются на +1
   - Поле `auction` обновляется автоматически

**Базовые цены позиций:**
- Рассчитываются по формуле: `20 + (total_positions - position) * 5`
- Топ позиция стоит дороже

**Примеры для Москвы (15 позиций):**
- Позиция #1: 90₽
- Позиция #2: 85₽
- Позиция #3: 80₽
- ...
- Позиция #15: 20₽

### 4. Обновление позиций

**Автоматически:**
- При размещении ставки через аукцион (поле `auction` обновляется в `backend/auction/index.py`)
- При сдвиге позиций (если кто-то перебил ставку)

**Вручную (администратор):**
Если нужно изменить позицию без аукциона, выполните SQL:
```sql
UPDATE listings 
SET auction = NEW_POSITION 
WHERE id = LISTING_ID;
```

**При добавлении нового отеля:**
Новый отель должен получить следующую свободную позицию в своём городе:
```sql
-- Получить максимальную позицию в городе
SELECT COALESCE(MAX(auction), 0) + 1 as next_position
FROM listings
WHERE city = 'Город' AND is_archived = FALSE;

-- Установить новому отелю
UPDATE listings 
SET auction = next_position
WHERE id = new_listing_id;
```

### 5. Проверка системы

**SQL для проверки позиций по городам:**
```sql
SELECT city, id, title, auction, owner_id
FROM listings
WHERE is_archived = FALSE
ORDER BY city, auction;
```

**SQL для проверки дубликатов позиций:**
```sql
SELECT city, auction, COUNT(*) as duplicates
FROM listings
WHERE is_archived = FALSE
GROUP BY city, auction
HAVING COUNT(*) > 1;
```
Результат должен быть пустым.

**SQL для проверки непрерывности позиций:**
```sql
SELECT 
  city,
  COUNT(*) as total_hotels,
  MAX(auction) as max_position,
  COUNT(*) = MAX(auction) as is_continuous
FROM listings
WHERE is_archived = FALSE
GROUP BY city;
```
`is_continuous` должен быть `true`.

## Backend функции

### 1. `backend/auction/index.py`
- **GET**: Возвращает информацию об аукционе для города
  - Показывает текущие позиции из поля `auction`
  - Показывает ставки из таблицы `auction_bids`
- **POST**: Размещение ставки
  - Обновляет поле `auction` при успешной ставке
  - Сдвигает позиции конкурентов

### 2. `backend/public-listings/index.py`
- Возвращает объекты с сортировкой: `ORDER BY city ASC, auction ASC`
- Обеспечивает правильный порядок на публичном сайте

### 3. `backend/owner-listings/index.py`
- Возвращает поле `auction` для отображения в личном кабинете

### 4. `backend/admin-listings/index.py`
- Возвращает поле `auction` для отображения в админ-панели

## Миграции

**V0019__set_auction_positions_by_city.sql:**
```sql
-- Установить позиции отелей по городам (начиная с 1 для каждого города)
WITH ranked_listings AS (
  SELECT 
    id,
    ROW_NUMBER() OVER (PARTITION BY city ORDER BY id ASC) as new_position
  FROM listings
  WHERE is_archived = FALSE
)
UPDATE listings l
SET auction = rl.new_position
FROM ranked_listings rl
WHERE l.id = rl.id;
```

Эта миграция была выполнена для инициализации системы позиций.

## Важные моменты

1. **Позиции уникальны внутри города** — нет дубликатов
2. **Позиции начинаются с 1** для каждого города
3. **Позиции непрерывны** — нет пропусков (1, 2, 3... N)
4. **Поле `auction` — источник истины** для текущей позиции
5. **Таблица `auction_bids`** — история ставок (опционально)
